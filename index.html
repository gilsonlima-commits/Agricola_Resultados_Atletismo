<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEEP Agrícola da Lapa - Resultados Atletismo oficial</title>
    <!-- Carrega Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Inter como padrão */
        body { font-family: 'Inter', sans-serif; }
        /* Estilos customizados para a tabela e botões */
        .table-header { background-color: #1e3a8a; color: white; }
        .data-row:nth-child(even) { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <!-- Conteúdo Principal do Aplicativo -->
    <div id="app" class="max-w-7xl mx-auto space-y-10">

        <!-- Título e Introdução -->
        <header class="text-center">
            <h1 class="text-4xl font-extrabold text-blue-900 mb-2">CEEP Agrícola da Lapa</h1>
            <p class="text-lg text-gray-600">Resultados Atletismo oficial</p>
        </header>

        <!-- Seção de Inserção de Resultados -->
        <section class="bg-white p-6 rounded-xl shadow-lg border border-blue-100">
            <h2 class="text-2xl font-semibold text-blue-800 mb-6 border-b pb-3">1. Inserir Novo Resultado</h2>
            
            <form id="resultForm" onsubmit="saveResult(event)">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    
                    <!-- ATLETA -->
                    <div>
                        <label for="atleta" class="block text-sm font-medium text-gray-700">Atleta</label>
                        <input type="text" id="atleta" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                    
                    <!-- COMPETIÇÃO -->
                    <div>
                        <label for="competicao" class="block text-sm font-medium text-gray-700">Competição</label>
                        <input type="text" id="competicao" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                    
                    <!-- DATA -->
                    <div>
                        <label for="data" class="block text-sm font-medium text-gray-700">Data</label>
                        <input type="date" id="data" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>

                    <!-- PROVA -->
                    <div>
                        <label for="prova" class="block text-sm font-medium text-gray-700">Prova</label>
                        <input type="text" id="prova" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="Ex: 100m Rasos, Salto em Distância">
                    </div>
                    
                    <!-- MARCA -->
                    <div>
                        <label for="marca" class="block text-sm font-medium text-gray-700">Marca</label>
                        <input type="text" id="marca" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="Ex: 10.50, 7.80m">
                    </div>
                    
                    <!-- CLASSIFICAÇÃO -->
                    <div>
                        <label for="classificacao" class="block text-sm font-medium text-gray-700">Classificação</label>
                        <input type="number" id="classificacao" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" min="1">
                    </div>
                    
                    <!-- OBS -->
                    <div class="lg:col-span-3">
                        <label for="obs" class="block text-sm font-medium text-gray-700">Observações (Opcional)</label>
                        <textarea id="obs" rows="2" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"></textarea>
                    </div>

                </div>

                <!-- Botão de Submissão -->
                <div class="mt-6 flex justify-end">
                    <button type="submit" id="saveButton" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 ease-in-out disabled:opacity-50">
                        Salvar Resultado
                    </button>
                </div>
            </form>
        </section>
        
        <!-- Mensagem de Feedback (Modal Customizado) -->
        <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
            <div id="messageContent" class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full text-center">
                <p id="messageText" class="text-lg font-medium"></p>
                <button onclick="closeMessageBox()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Fechar</button>
            </div>
        </div>

        <!-- Seção de Visualização e Download -->
        <section class="bg-white p-6 rounded-xl shadow-lg border border-green-100">
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                <h2 class="text-2xl font-semibold text-green-800">2. Resultados Registrados</h2>
                <!-- Botão de Download XLSX -->
                <button onclick="downloadResults()" class="px-4 py-2 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-150 ease-in-out flex items-center disabled:opacity-50" id="downloadButton" disabled>
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Baixar XLSX
                </button>
            </div>

            <!-- Tabela de Resultados -->
            <div class="overflow-x-auto rounded-lg shadow-inner border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="table-header">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider rounded-tl-lg">Atleta</th>
                            <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider">Competição</th>
                            <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider">Data</th>
                            <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider">Prova</th>
                            <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider">Marca</th>
                            <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider">Class.</th>
                            <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider rounded-tr-lg">Obs.</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Os resultados serão injetados aqui pelo JavaScript -->
                        <tr>
                            <td colspan="7" class="py-4 text-center text-gray-500">
                                <span id="loadingMessage">Carregando resultados...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

    </div>
    
    <!-- Importações do Firebase e SheetJS (XLSX) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            onSnapshot,
            orderBy,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Define o nível de log para debug
        setLogLevel('Debug');

        // Variáveis globais (disponíveis no ambiente Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let isAuthReady = false;
        let currentUserId = null;

        // URL da coleção pública para resultados de atletismo
        const COLLECTION_PATH = `/artifacts/${appId}/public/data/athletic_results`;

        // Função para mostrar mensagens de feedback customizadas
        function showMessageBox(message, type = 'success') {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            
            messageText.textContent = message;
            
            // Define a cor da mensagem baseada no tipo (sucesso/erro)
            if (type === 'error') {
                messageText.classList.remove('text-green-600');
                messageText.classList.add('text-red-600');
            } else {
                messageText.classList.remove('text-red-600');
                messageText.classList.add('text-green-600');
            }

            messageBox.classList.remove('hidden');
            messageBox.classList.add('flex');
            
            // Expõe a função globalmente para o HTML
            window.closeMessageBox = () => {
                messageBox.classList.add('hidden');
                messageBox.classList.remove('flex');
            };
        }
        window.showMessageBox = showMessageBox; // Torna global

        /**
         * Inicializa o Firebase e realiza a autenticação.
         */
        async function initializeFirebase() {
            try {
                // VERIFICAÇÃO ADICIONAL PARA CONFIGURAÇÃO AUSENTE/INVÁLIDA
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    throw new Error("A configuração do Firebase (API Key, Project ID, etc.) está ausente ou inválida. Certifique-se de que o ambiente está fornecendo as credenciais corretas.");
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 1. Configura o Listener ANTES de tentar o login.
                // O Listener irá capturar o estado de autenticação (logado/deslogado) após as tentativas abaixo.
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isAuthReady = true;
                        console.log("Firebase Auth listener: User ready, loading results. ID:", currentUserId);
                        loadResults(); // Inicia o carregamento dos dados SOMENTE após autenticação bem-sucedida
                    } else {
                        currentUserId = null;
                        isAuthReady = false;
                        console.log("Firebase Auth listener: No user signed in.");
                        // Não tentamos signInAnonymously aqui, pois a lógica de sign-in inicial (passo 2) já cuidou disso.
                    }
                });

                // 2. Inicia o processo de Sign-in (Custom ou Anônimo)
                // Usamos await para garantir que a autenticação seja tentada antes que o listener seja acionado pela primeira vez.
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Autenticação com token customizado bem-sucedida.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Autenticação anônima padrão acionada.");
                }
            } catch (error) {
                console.error("Erro na inicialização ou autenticação do Firebase:", error);
                // Exibe a mensagem de erro detalhada, incluindo a nova verificação de API Key/Config
                showMessageBox("Erro crítico de conexão/autenticação: " + error.message, 'error');
            }
        }

        /**
         * Salva um novo resultado no Firestore.
         * @param {Event} event - O evento de submissão do formulário.
         */
        async function saveResult(event) {
            event.preventDefault();
            
            if (!db || !isAuthReady) {
                showMessageBox("O banco de dados não está pronto. Tente novamente em instantes.", 'error');
                return;
            }

            const button = document.getElementById('saveButton');
            button.disabled = true;
            button.textContent = 'Salvando...';

            try {
                const result = {
                    ATLETA: document.getElementById('atleta').value.trim(),
                    COMPETICAO: document.getElementById('competicao').value.trim(),
                    DATA: document.getElementById('data').value, // Formato YYYY-MM-DD
                    PROVA: document.getElementById('prova').value.trim(),
                    MARCA: document.getElementById('marca').value.trim(),
                    CLASSIFICACAO: parseInt(document.getElementById('classificacao').value),
                    OBS: document.getElementById('obs').value.trim(),
                    // Adiciona um timestamp para ordenação
                    timestamp: serverTimestamp(),
                    // Adiciona o ID do usuário que inseriu, para fins de auditoria
                    userId: currentUserId 
                };

                // Adiciona o documento à coleção
                await addDoc(collection(db, COLLECTION_PATH), result);

                showMessageBox("Resultado salvo com sucesso!");
                document.getElementById('resultForm').reset(); // Limpa o formulário

            } catch (e) {
                console.error("Erro ao adicionar documento: ", e);
                // Sugere que a regra de segurança pode estar bloqueando a escrita
                showMessageBox(`Erro ao salvar o resultado. Verifique as permissões de escrita (write) no Firebase: ${e.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Salvar Resultado';
            }
        }
        window.saveResult = saveResult; // Torna a função global

        /**
         * Consulta e exibe os resultados em tempo real na tabela HTML.
         */
        function loadResults() {
            if (!db || !isAuthReady) {
                console.warn("DB ou Auth não estão prontos. Adicionando listener mais tarde.");
                return;
            }

            const resultsTableBody = document.getElementById('resultsTableBody');
            const downloadButton = document.getElementById('downloadButton');
            const loadingMessage = document.getElementById('loadingMessage');
            
            // Oculta a mensagem de carregamento inicial
            if (loadingMessage) loadingMessage.parentNode.style.display = 'none';

            // A ordenação primária por DATA (decrescente) é mantida na consulta do Firestore.
            const q = query(collection(db, COLLECTION_PATH), orderBy("DATA", "desc"));
            
            // Listener em tempo real (onSnapshot)
            onSnapshot(q, (querySnapshot) => {
                const fetchedResults = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Coleta todos os dados brutos
                    fetchedResults.push({
                        ATLETA: data.ATLETA,
                        COMPETICAO: data.COMPETICAO,
                        DATA: data.DATA, // YYYY-MM-DD
                        PROVA: data.PROVA,
                        MARCA: data.MARCA,
                        CLASSIFICACAO: data.CLASSIFICACAO,
                        OBS: data.OBS || ''
                    });
                });
                
                // Ordenação Secundária em JavaScript: DATA (decrescente) e ATLETA (crescente)
                fetchedResults.sort((a, b) => {
                    // 1. Primary Sort (DATA, Descending)
                    if (a.DATA < b.DATA) return 1;
                    if (a.DATA > b.DATA) return -1;
                    
                    // 2. Secondary Sort (ATLETA, Ascending) - Only if dates are equal
                    return a.ATLETA.localeCompare(b.ATLETA);
                });

                // --- Geração da Tabela e Download Data ---
                let htmlRows = '';
                
                if (fetchedResults.length === 0) {
                    htmlRows = `<tr><td colspan="7" class="py-8 text-center text-gray-500 italic">Nenhum resultado registrado ainda.</td></tr>`;
                    downloadButton.disabled = true;
                } else {
                    fetchedResults.forEach((data) => {
                        // Formata a data para exibição (DD/MM/AAAA)
                        const dateParts = data.DATA.split('-'); 
                        const formattedDate = dateParts.length === 3 ? `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}` : data.DATA;

                        htmlRows += `
                            <tr class="data-row hover:bg-blue-50 transition duration-100">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${data.ATLETA}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.COMPETICAO}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formattedDate}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.PROVA}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-700">${data.MARCA}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-600">${data.CLASSIFICACAO}º</td>
                                <td class="px-6 py-4 whitespace-pre-wrap text-sm text-gray-500">${data.OBS || '-'}</td>
                            </tr>
                        `;
                    });
                    downloadButton.disabled = false;
                }
                
                resultsTableBody.innerHTML = htmlRows;
                // Armazena os resultados JÁ ORDENADOS para uso na função de download
                window.athleticResults = fetchedResults; 
                
            }, (error) => {
                console.error("Erro ao carregar dados em tempo real: ", error);
                let errorMessage = error.message;
                
                if (errorMessage.includes("permission")) {
                    errorMessage = "Erro de Permissão: As regras de segurança do Firebase estão bloqueando a leitura dos resultados. Certifique-se de que o acesso anônimo/público de leitura (read) está permitido para esta coleção.";
                }

                resultsTableBody.innerHTML = `<tr><td colspan="7" class="py-8 text-center text-red-500 font-medium">${errorMessage}</td></tr>`;
                downloadButton.disabled = true;
            });
        }
        
        // Inicializa o Firebase ao carregar o script
        initializeFirebase();

    </script>
    
    <!-- Importação do SheetJS para download de XLSX -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <script>
        // Função para gerar e baixar o arquivo XLSX
        function downloadResults() {
            if (typeof XLSX === 'undefined' || !window.athleticResults || window.athleticResults.length === 0) {
                showMessageBox("Nenhum dado disponível para download ou biblioteca XLSX não carregada.", 'error');
                return;
            }

            const downloadButton = document.getElementById('downloadButton');
            downloadButton.disabled = true;
            const originalText = downloadButton.innerHTML;
            downloadButton.innerHTML = '<svg class="w-5 h-5 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v16m0 0h16M4 20h16M20 4v16"></path></svg> Gerando...';

            try {
                // 1. Cria a planilha de trabalho (Work Sheet - WS) a partir do array de objetos
                const ws = XLSX.utils.json_to_sheet(window.athleticResults);
                
                // 2. Cria o livro de trabalho (Work Book - WB)
                const wb = XLSX.utils.book_new();
                
                // 3. Adiciona a planilha ao livro
                XLSX.utils.book_append_sheet(wb, ws, "Resultados Atletismo");

                // 4. Gera e baixa o arquivo
                const dateString = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(wb, `Resultados_Atletismo_${dateString}.xlsx`);
                
                showMessageBox("Download do arquivo XLSX concluído.");

            } catch (e) {
                console.error("Erro ao gerar XLSX: ", e);
                showMessageBox("Erro ao gerar arquivo XLSX: " + e.message, 'error');
            } finally {
                downloadButton.disabled = false;
                downloadButton.innerHTML = originalText;
            }
        }
        window.downloadResults = downloadResults; // Torna a função global
    </script>
</body>
</html>